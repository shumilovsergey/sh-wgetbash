{% extends 'base.html' %}
{% block title %}
Скрипты - WgetBash
{% endblock %}
{% block content %}
{% load static %}

<style>
/* Ensure light theme for scripts page */
body {
    background: #ffffff !important;
    color: #0f172a !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .create-button {
        font-size: 1rem !important;
        padding: 16px 24px !important;
    }
    
    .script-header {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 16px !important;
    }
    
    .script-actions {
        justify-content: center !important;
    }
}
</style>

<div style="min-height: 100vh; background: #ffffff; padding: 32px;">
  <div style="max-width: 800px; margin: 0 auto;">
    
    {% if script_list %}
    <!-- Scripts List -->
    <div style="padding-top: 32px;">
      
      <!-- Header with Create Button -->
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 32px;">
        <h1 style="font-size: 2rem; font-weight: 700; color: #0f172a; margin: 0;">Ваши скрипты</h1>
        <form action="{% url 'api:script_create' %}" method="GET">
          <button style="display: inline-flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 4px; cursor: pointer; border: 2px solid #2563eb; outline: none; background: #2563eb; color: white; box-shadow: 0 2px 0 rgba(0, 0, 0, 0.1); transition: all 0.1s ease-out;"
                  type="submit"
                  title="Создать скрипт"
                  onmouseover="this.style.background='#1d4ed8'; this.style.borderColor='#1d4ed8'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 0 rgba(0, 0, 0, 0.15)';"
                  onmouseout="this.style.background='#2563eb'; this.style.borderColor='#2563eb'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 0 rgba(0, 0, 0, 0.1)';">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
          </button>
        </form>
      </div>

      <!-- Scripts List -->
      <div style="display: flex; flex-direction: column; gap: 16px;">
        {% for script in script_list %}
        <!-- Script Card -->
        <div class="script-item" style="display: flex; align-items: center; justify-content: space-between; padding: 24px; background: #ffffff; border: 2px solid #e2e8f0; border-radius: 4px; box-shadow: 0 2px 0 rgba(0, 0, 0, 0.1); transition: all 0.1s ease-out; cursor: pointer;"
             onclick="window.location.href='{% url 'api:script_id' script_id=script.id %}'"
             onmouseover="this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 4px 0 rgba(0, 0, 0, 0.15)';"
             onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='0 2px 0 rgba(0, 0, 0, 0.1)';">
          
          <!-- Script Info (Left Side) -->
          <div style="flex: 1;">
            <h3 style="font-size: 1.125rem; font-weight: 600; color: #0f172a; margin: 0 0 4px 0;">{{script.name}}</h3>
            <p style="font-size: 0.875rem; color: #64748b; margin: 0;">Создан: {{script.created|date:"d.m.Y в H:i"}}</p>
          </div>

          <!-- Action Buttons (Right Side) -->
          <div class="script-actions" style="display: flex; gap: 8px; align-items: center;">
            <!-- Expand Button -->
            <button onclick="event.stopPropagation(); toggleScript('{{script.id}}')" 
                    style="display: inline-flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 4px; cursor: pointer; border: 2px solid #64748b; outline: none; background: #64748b; color: white; box-shadow: 0 2px 0 rgba(0, 0, 0, 0.1); transition: all 0.1s ease-out;"
                    title="Показать содержимое"
                    onmouseover="this.style.background='#475569'; this.style.borderColor='#475569'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 0 rgba(0, 0, 0, 0.15)';"
                    onmouseout="this.style.background='#64748b'; this.style.borderColor='#64748b'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 0 rgba(0, 0, 0, 0.1)';">
              <svg id="arrow-{{script.id}}" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="transition: transform 0.2s ease-out;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            
            <!-- Copy Button -->
            <button onclick="event.stopPropagation(); copyToClipboard('{{script.id}}')" 
                    style="display: inline-flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 4px; cursor: pointer; border: 2px solid #059669; outline: none; background: #059669; color: white; box-shadow: 0 2px 0 rgba(0, 0, 0, 0.1); transition: all 0.1s ease-out;"
                    title="Скопировать команду"
                    onmouseover="this.style.background='#047857'; this.style.borderColor='#047857'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 0 rgba(0, 0, 0, 0.15)';"
                    onmouseout="this.style.background='#059669'; this.style.borderColor='#059669'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 0 rgba(0, 0, 0, 0.1)';">
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
            </button>
            
            <!-- Delete Button -->
            <button onclick="event.stopPropagation(); confirmDelete('{{script.id}}')" 
                    style="display: inline-flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 4px; cursor: pointer; border: 2px solid #dc2626; outline: none; background: #dc2626; color: white; box-shadow: 0 2px 0 rgba(0, 0, 0, 0.1); transition: all 0.1s ease-out;"
                    title="Удалить скрипт"
                    onmouseover="this.style.background='#b91c1c'; this.style.borderColor='#b91c1c'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 0 rgba(0, 0, 0, 0.15)';"
                    onmouseout="this.style.background='#dc2626'; this.style.borderColor='#dc2626'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 0 rgba(0, 0, 0, 0.1)';">
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
        </div>
        
        <!-- Separate Script Content Section (Initially Hidden) -->
        <div id="content-{{script.id}}" style="display: none; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 4px; box-shadow: 0 2px 0 rgba(0, 0, 0, 0.1); margin-bottom: 8px;">
          <div style="padding: 24px;">
            <div style="background: #ffffff; border: 2px solid #e2e8f0; border-radius: 4px; padding: 16px;">
              <pre style="font-family: 'JetBrains Mono', 'Fira Code', 'Monaco', 'Consolas', monospace; font-size: 0.75rem; line-height: 1.5; color: #0f172a; margin: 0; white-space: pre-wrap; word-wrap: break-word;">{{script.text}}</pre>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    
    {% else %}
    <!-- Empty State - Centered Create Button -->
    <div style="display: flex; justify-content: center; align-items: center; min-height: 60vh;">
      <form action="{% url 'api:script_create' %}" method="GET">
        <button class="create-button" style="display: inline-flex; align-items: center; justify-content: center; gap: 12px; padding: 24px 48px; border-radius: 4px; font-size: 1.125rem; font-weight: 600; cursor: pointer; border: 2px solid #2563eb; outline: none; background: #2563eb; color: white; box-shadow: 0 4px 0 rgba(0, 0, 0, 0.15); transition: all 0.1s ease-out;"
                type="submit"
                onmouseover="this.style.background='#1d4ed8'; this.style.borderColor='#1d4ed8'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 0 rgba(0, 0, 0, 0.2)';"
                onmouseout="this.style.background='#2563eb'; this.style.borderColor='#2563eb'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 0 rgba(0, 0, 0, 0.15)';">
          <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Создать скрипт
        </button>
      </form>
    </div>
    {% endif %}
  </div>
</div>

<!-- Success Alert -->
<div id="alert" style="position: fixed; top: 32px; right: 32px; background: #f0fdf4; border: 2px solid #059669; color: #059669; padding: 16px 24px; border-radius: 4px; box-shadow: 0 4px 0 rgba(0, 0, 0, 0.15); display: none; z-index: 1000;">
  <div style="display: flex; align-items: center; gap: 8px;">
    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
    </svg>
    Команда скопирована в буфер обмена
  </div>
</div>

<script>
    let currentExpandedScript = null;
    
    // Toggle script expansion
    function toggleScript(scriptId) {
        const content = document.getElementById('content-' + scriptId);
        const arrow = document.getElementById('arrow-' + scriptId);
        
        if (!content || !arrow) return;
        
        // If clicking on the currently expanded script, just collapse it
        if (currentExpandedScript === scriptId) {
            content.style.display = 'none';
            arrow.style.transform = 'rotate(0deg)';
            currentExpandedScript = null;
            return;
        }
        
        // Collapse the previously expanded script if any
        if (currentExpandedScript) {
            const prevContent = document.getElementById('content-' + currentExpandedScript);
            const prevArrow = document.getElementById('arrow-' + currentExpandedScript);
            if (prevContent && prevArrow) {
                prevContent.style.display = 'none';
                prevArrow.style.transform = 'rotate(0deg)';
            }
        }
        
        // Expand the clicked script
        content.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
        currentExpandedScript = scriptId;
    }
    
    function copyToClipboard(script_id) {
        const textToCopy = "wget https://{{request.get_host}}/script_raw/" + script_id + "/ -O script_" + script_id + ".sh && chmod +x script_" + script_id + ".sh && ./script_" + script_id + ".sh";
        
        const alertBox = document.getElementById('alert');
        
        // Create temporary textarea for copying
        const textarea = document.createElement('textarea');
        textarea.value = textToCopy;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);

        // Show success alert
        alertBox.style.display = 'block';
        
        // Hide alert after 3 seconds
        setTimeout(function() {
            alertBox.style.display = 'none';
        }, 3000);
    }
    
    function confirmDelete(scriptId) {
        if (confirm('Вы уверены, что хотите удалить этот скрипт?')) {
            // Create a form dynamically and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/script_delete/' + scriptId + '/';
            form.style.display = 'none';
            
            // Add CSRF token
            const csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrfmiddlewaretoken';
            csrfToken.value = getCookie('csrftoken');
            form.appendChild(csrfToken);
            
            document.body.appendChild(form);
            form.submit();
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

{% endblock %}